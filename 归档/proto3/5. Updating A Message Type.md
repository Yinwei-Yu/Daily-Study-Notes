# 更新 Protobuf 消息类型

当现有消息类型无法满足需求时（例如，想添加一个字段），我们可以在不破坏现有代码的情况下平滑地更新它。
## 核心原则

- **二进制格式（Binary Wire Format）**：更新规则相对宽松。
- **JSON 或文本格式（ProtoJSON / Proto Text）**：更新规则更严格。

## 二进制格式下的变更类型

### 1. 非安全变更 (Wire-unsafe Changes)

这类变更会破坏向前或向后兼容性，导致新旧代码无法解析对方序列化后的数据。**只有在能确保所有客户端和服务端都同步更新到新 Schema 时，才能进行此类变更。**

- **禁止修改任何已有字段的字段编号 (Field Number)**。
  - 修改字段编号等同于“删除旧字段，再添加一个同类型的新字段”。
- **禁止将已有字段移入一个 `oneof` 结构中**。

### 2. 安全变更 (Wire-safe Changes)

这类变更是完全安全的，新旧代码可以无缝解析对方数据，不会造成数据丢失或解析失败。

- **添加新字段**。
  - 旧代码解析新消息时，会直接忽略新字段。
  - 新代码解析旧消息时，新添加的字段会使用其类型的默认值。
- **移除字段**。
  - **重要**：被移除字段的**字段编号绝不能被再次使用**。
  - 最佳实践：
    1.  将字段重命名，加上 `OBSOLETE_` 前缀。
    2.  使用 `reserved` 关键字将该字段编号保留，防止未来被误用。
- **为 `enum` 添加新值**。
- **将单个字段或 `extension` 移入一个新的 `oneof` 结构中**。
- **将只包含一个字段的 `oneof` 结构改回单个字段**。
- **将一个字段变更为类型和编号都相同的 `extension`**。

### 3. 兼容变更 (Wire-compatible / Conditionally Safe)

这类变更在二进制层面是兼容的，即新旧代码都能解析数据，但**可能导致数据丢失或精度下降**。进行此类变更需要谨慎地管理发布流程。

- **整数类型兼容性**：
  - `int32`, `uint32`, `int64`, `uint64`, `bool` 之间相互兼容。
  - **注意**：如果将 `int64` 的值存入 `int32` 字段，会发生**截断**（类似 C++ 的强制类型转换）。
  - `sint32` 和 `sint64` 相互兼容，但与其他整数类型不兼容。
- **`string` 和 `bytes`**：
  - 只要 `bytes` 是合法的 UTF-8 编码，二者就兼容。
- **`bytes` 和内嵌消息 (Embedded Message)**：
  - 如果 `bytes` 中包含了该消息的编码后实例，二者兼容。
- **`fixed32` 与 `sfixed32`**，**`fixed64` 与 `sfixed64`** 相互兼容。
- **`singular` 与 `repeated`**：
  - 对于 `string`, `bytes`, `message` 类型的字段，`singular` (单个) 和 `repeated` (重复) 是兼容的。
  - 当期望 `singular` 的客户端收到 `repeated` 数据时：
    - 如果是原始类型，它会取最后一个值。
    - 如果是消息类型，它会合并所有元素。
  - **注意**：对于数字类型（包括 `bool` 和 `enum`）通常不安全，因为 `repeated` 字段默认使用 `packed` 格式序列化，`singular` 字段无法正确解析。
- **`enum` 与整数类型**：
  - `enum` 与 `int32`, `uint32`, `int64`, `uint64` 兼容。
  - **注意**：反序列化时，无法识别的 `enum` 值会作为未知字段保留，但不同语言的处理方式可能不同。
- **`map<K, V>` 与其等价的 `repeated` 消息字段**：
  - 二进制兼容。
  - **注意**：使用 `map` 的客户端可能会重排条目或丢弃重复键的条目。

## 未知字段 (Unknown Fields)

当解析器遇到无法识别的字段时（例如，旧代码解析包含新字段的数据），这些字段就成为“未知字段”。

- **Proto3 行为**：默认会**保留**未知字段。当消息被再次序列化时,这些未知字段也会被一同写入。
- **如何避免丢失未知字段**：
  - **使用二进制格式**进行数据交换，避免使用 JSON 或文本格式。
  - 使用面向消息的 API（如 `CopyFrom()`, `MergeFrom()`）来复制数据，而不是逐个字段地复制。

---

**总结**：更新 Protobuf 消息时，应优先选择“安全变更”。如果必须进行“兼容变更”，则需要仔细规划发布策略，确保系统平稳过渡。应极力避免“非安全变更”，除非你能控制所有通信端点。
