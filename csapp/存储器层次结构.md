
# 存储器层次结构中的缓存

**高速缓存**(cache)是一个小而快速的存储设备,作为存储在更大更慢的设备中的数据对象的缓冲区域,使用高速缓存的过程称为**缓存**

存储器层次结构的中心思想:
对于每个k,位于k层的更快更小的存储设备作为位于k+1层的更大更慢的设备的缓存

下图是一个例子:

![[Pasted image 20240815202628.png]]
第k+1层的存储器被划分为连续的数据对象**组块(chunk)**,称为**块(block)**,每个块有唯一的地址,块的大小可固定可变化

第k层的存储器被划分为较少的块的集合,每个块的大小和k+1层的块的大小相同,k层包含有k+1层的块的一个子集的副本

数据以块大小为传送单元在相邻的两个层之间进行复制,在层级结构中任何一对相邻的层次之间的块的大小是固定的,但是其他的层次对之间可以有不同的块的大小
[[csapp-zh-book#^upt60z4qv3s|例如]]

在读取数据时,会有缓存命中和缓存不命中两种情况:

1. 缓存命中

当程序需要某个在k+1层中的数据对象d时,会先在k层查找d,若d正好在第k层中,则缓存命中,比如上图中读取块14

2. 缓存不命中

若d不在第k层中,则换粗不命中.k层从k+1层缓存中取出包含d的那个块,若k层已经满了,还需要覆盖一个现存的块

覆盖现存的块的过程称为驱逐或者替换这个块,被替换的块称为牺牲快,决定替换哪个块的方式由缓存的**替换策略**控制.
eg.[[csapp-zh-book#^4wph205521k|随机替换策略]]
[[csapp-zh-book#^5lrni62qndo| LRU]]

**缓存不命中的种类**

1. k层缓存为空,这个缓存被称为**冷缓存**,这种不命中称为**强制性不命中**或者**冷不命中**.这种不命中通常是短暂事件,不会在反复访问存储器使得缓存**暖身**之后的稳定状态出现
2. **冲突不命中**:源于不命中时的一种放置策略.将k+1层中的某个块限制放在k层的一个小子集中,比如采用$i \, mod \, 4$的方式,在上面的图片中,0 4 8 12将在同一个位置,那么若连续引用0 4 8 12这四个块,则每次引用都不命中
3. **容量不命中**:程序通常按照一系列的阶段来运行,每个阶段访问缓存块的某个相对稳定的不变的集合,这个块的集合称为当前的**工作集**,当工作集的大小大于缓存时,会出现**容量不命中**

---

对于每一层,某种形式的逻辑必须管理缓存,即将缓存划分为块,在不同的层之间传送块,判定命中还是不命中,并进行处理.
下面是一些例子:

- 编译器-寄存器文件
- 内置于缓存的硬件逻辑-L1 L2 L3
- os和cpu-DRAM
- 本地机器的AFS客户端进程-具有AFS分布式文件系统的本地磁盘

详情如下:
![[Pasted image 20240815204606.png]]